<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Optimizer - ë°±ì—”ë“œ ì—°ë™</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-blue: #0046FF;
      --accent-blue: #73C8D2;
      --bg-beige: #F5F1DC;
      --highlight-orange: #FF9013;
      --white: #FFFFFF;
      --text-dark: #1A1A1A;
      --text-gray: #6B6B6B;
      --border-light: #E0DDD0;
      --success: #27AE60;
      --error: #E74C3C;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
      background-color: var(--bg-beige);
      color: var(--text-dark);
      line-height: 1.6;
    }

    /* Header */
    .header {
      background-color: var(--white);
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 8px rgba(0, 70, 255, 0.08);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary-blue);
    }

    .nav {
      display: flex;
      gap: 2rem;
    }

    .nav-link {
      color: var(--text-dark);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.3s;
      position: relative;
    }

    .nav-link:hover {
      color: var(--primary-blue);
    }

    .nav-link.active::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: var(--highlight-orange);
      border-radius: 2px;
    }

    /* Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Section */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Card */
    .card {
      background-color: var(--white);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 70, 255, 0.06);
      margin-bottom: 1.5rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--bg-beige);
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-dark);
    }

    /* Button */
    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.95rem;
    }

    .btn-primary {
      background-color: var(--primary-blue);
      color: var(--white);
    }

    .btn-primary:hover {
      background-color: #0039CC;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 70, 255, 0.3);
    }

    .btn-secondary {
      background-color: var(--accent-blue);
      color: var(--white);
    }

    .btn-secondary:hover {
      background-color: #5DB4C0;
    }

    .btn-outline {
      background-color: transparent;
      color: var(--primary-blue);
      border: 2px solid var(--primary-blue);
    }

    .btn-outline:hover {
      background-color: var(--primary-blue);
      color: var(--white);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Form Controls */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-dark);
    }

    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border-light);
      border-radius: 8px;
      font-size: 0.95rem;
      transition: border-color 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--primary-blue);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
    }

    /* Weight Controls */
    .weight-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .weight-item {
      background-color: var(--bg-beige);
      padding: 1rem;
      border-radius: 8px;
    }

    .weight-label {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
    }

    .weight-input {
      width: 100%;
      padding: 0.5rem;
      border: 2px solid var(--border-light);
      border-radius: 6px;
      font-size: 1rem;
      text-align: center;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table thead {
      background-color: var(--bg-beige);
    }

    .table th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-dark);
      border-bottom: 2px solid var(--border-light);
    }

    .table td {
      padding: 1rem;
      border-bottom: 1px solid var(--border-light);
    }

    .table tbody tr:hover {
      background-color: rgba(115, 200, 210, 0.05);
    }

    /* Stock Item */
    .stock-symbol {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue));
      color: var(--white);
      border-radius: 6px;
      font-weight: 700;
      font-size: 0.85rem;
    }

    /* Alert */
    .alert {
      padding: 1rem 1.5rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .alert-info {
      background-color: rgba(115, 200, 210, 0.15);
      border-left: 4px solid var(--accent-blue);
      color: var(--text-dark);
    }

    .alert-success {
      background-color: rgba(39, 174, 96, 0.15);
      border-left: 4px solid var(--success);
      color: var(--text-dark);
    }

    .alert-warning {
      background-color: rgba(255, 144, 19, 0.15);
      border-left: 4px solid var(--highlight-orange);
      color: var(--text-dark);
    }

    .alert-error {
      background-color: rgba(231, 76, 60, 0.15);
      border-left: 4px solid var(--error);
      color: var(--text-dark);
    }

    /* Loading Spinner */
    .spinner {
      border: 3px solid var(--bg-beige);
      border-top: 3px solid var(--primary-blue);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Checkbox */
    .checkbox-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    /* Badge */
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .badge-primary {
      background-color: rgba(0, 70, 255, 0.15);
      color: var(--primary-blue);
    }

    .badge-success {
      background-color: rgba(39, 174, 96, 0.15);
      color: var(--success);
    }

    .badge-orange {
      background-color: rgba(255, 144, 19, 0.15);
      color: var(--highlight-orange);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--white) 0%, var(--bg-beige) 100%);
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 70, 255, 0.06);
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-gray);
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary-blue);
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 2rem;
    }

    .page-btn {
      padding: 0.5rem 1rem;
      border: 2px solid var(--border-light);
      background-color: var(--white);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .page-btn:hover {
      background-color: var(--primary-blue);
      color: var(--white);
      border-color: var(--primary-blue);
    }

    .page-btn.active {
      background-color: var(--primary-blue);
      color: var(--white);
      border-color: var(--primary-blue);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      .nav {
        gap: 1rem;
      }

      .weight-controls,
      .form-row {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<!-- Header -->
<header class="header">
  <div class="header-content">
    <div class="logo">ğŸ“Š Portfolio Optimizer</div>
    <nav class="nav">
      <a class="nav-link active" data-section="dashboard">ëŒ€ì‹œë³´ë“œ</a>
      <a class="nav-link" data-section="screening">ìŠ¤í¬ë¦¬ë‹</a>
      <a class="nav-link" data-section="selection">ìì‚° ì„ íƒ</a>
      <a class="nav-link" data-section="correlation">ìƒê´€ê´€ê³„</a>
    </nav>
  </div>
</header>

<!-- Main Container -->
<div class="container">
  <!-- Dashboard Section -->
  <section id="dashboard" class="section active">
    <div class="alert alert-info">
      <span>ğŸ’¡</span>
      <div>
        <strong>ì‹œìŠ¤í…œ ìƒíƒœ:</strong> ë°±ì—”ë“œ API ì—°ë™ ì¤€ë¹„ ì™„ë£Œ
        <div style="margin-top: 0.25rem; font-size: 0.9rem;">
          API ê¸°ë³¸ URL: <code id="api-url">http://localhost:8080</code>
        </div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">ì „ì²´ ì¢…ëª© ìˆ˜</div>
        <div class="stat-value" id="total-stocks">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ìŠ¤í¬ë¦¬ë‹ ì™„ë£Œ</div>
        <div class="stat-value" id="screening-count">-</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì„ íƒí•œ ì¢…ëª©</div>
        <div class="stat-value" id="selected-count">0</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-title">API ì—°ê²° í…ŒìŠ¤íŠ¸</div>
      </div>
      <div class="form-group">
        <label class="form-label">API Base URL</label>
        <input type="text" id="api-base-url" class="form-control" value="http://localhost:8282" placeholder="http://localhost:8282">
      </div>
      <button class="btn btn-primary" onclick="testConnection()">ğŸ”Œ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
      <div id="connection-result" style="margin-top: 1rem;"></div>
    </div>
  </section>

  <!-- Screening Section -->
  <section id="screening" class="section">
    <div class="card">
      <div class="card-header">
        <div class="card-title">ë©€í‹°íŒ©í„° ìŠ¤í¬ë¦¬ë‹</div>
        <button class="btn btn-secondary btn-sm" onclick="resetWeights()">ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹</button>
      </div>

      <div class="alert alert-warning">
        <span>âš™ï¸</span>
        <div>
          <strong>ê°€ì¤‘ì¹˜ ì„¤ì •:</strong> PER, PBR, ROEì˜ í•©ê³„ëŠ” 100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
        </div>
      </div>

      <div class="weight-controls">
        <div class="weight-item">
          <div class="weight-label">PER ê°€ì¤‘ì¹˜</div>
          <input type="number" id="per-weight" class="weight-input" value="33.33" min="0" max="100" step="0.01" oninput="updateWeights()">
          <div style="text-align: center; margin-top: 0.5rem; color: var(--text-gray); font-size: 0.85rem;">%</div>
        </div>
        <div class="weight-item">
          <div class="weight-label">PBR ê°€ì¤‘ì¹˜</div>
          <input type="number" id="pbr-weight" class="weight-input" value="33.33" min="0" max="100" step="0.01" oninput="updateWeights()">
          <div style="text-align: center; margin-top: 0.5rem; color: var(--text-gray); font-size: 0.85rem;">%</div>
        </div>
        <div class="weight-item">
          <div class="weight-label">ROE ê°€ì¤‘ì¹˜</div>
          <input type="number" id="roe-weight" class="weight-input" value="33.34" min="0" max="100" step="0.01" oninput="updateWeights()">
          <div style="text-align: center; margin-top: 0.5rem; color: var(--text-gray); font-size: 0.85rem;">%</div>
        </div>
      </div>

      <div style="text-align: center; margin-bottom: 1.5rem;">
        <div style="font-size: 0.9rem; color: var(--text-gray);">í•©ê³„:</div>
        <div id="weight-sum" style="font-size: 1.5rem; font-weight: 700; color: var(--primary-blue);">100.00%</div>
      </div>

      <div class="form-group">
        <label class="form-label">ìµœëŒ€ ë¶€ì±„ë¹„ìœ¨</label>
        <input type="number" id="max-debt-ratio" class="form-control" value="2.0" step="0.1" min="0">
      </div>

      <button class="btn btn-primary" style="width: 100%;" onclick="performScreening()">
        ğŸ” ìŠ¤í¬ë¦¬ë‹ ì‹¤í–‰
      </button>

      <div id="screening-result" style="margin-top: 1.5rem;"></div>
    </div>

    <!-- Screening Results -->
    <div class="card" id="screening-results-card" style="display: none;">
      <div class="card-header">
        <div class="card-title">ìŠ¤í¬ë¦¬ë‹ ê²°ê³¼</div>
        <div>
          <span class="badge badge-primary" id="result-count">0ê°œ ì¢…ëª©</span>
        </div>
      </div>
      <div class="table-container">
        <table class="table">
          <thead>
          <tr>
            <th>ìˆœìœ„</th>
            <th>í‹°ì»¤</th>
            <th>ì¢…ëª©ëª…</th>
            <th>ì—…ì¢…</th>
            <th>PER</th>
            <th>PBR</th>
            <th>ROE</th>
            <th>ì¢…í•©ì ìˆ˜</th>
            <th>ì„ ë³„</th>
          </tr>
          </thead>
          <tbody id="screening-results-body">
          </tbody>
        </table>
      </div>
      <div class="pagination" id="screening-pagination"></div>
    </div>
  </section>

  <!-- Selection Section -->
  <section id="selection" class="section">
    <div class="card">
      <div class="card-header">
        <div class="card-title">ì£¼ì‹ ê²€ìƒ‰ ë° ì„ íƒ</div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ê²€ìƒ‰ íƒ€ì…</label>
          <select id="search-type" class="form-control">
            <option value="keyword">ì¢…ëª©ëª…</option>
            <option value="ticker">í‹°ì»¤</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ê²€ìƒ‰ì–´</label>
          <input type="text" id="search-value" class="form-control" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="form-group">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-primary" style="width: 100%;" onclick="searchStocks()">ğŸ” ê²€ìƒ‰</button>
        </div>
      </div>

      <div id="search-results"></div>
    </div>

    <!-- Selected Assets -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">ì„ íƒí•œ ì¢…ëª© (5~10ê°œ)</div>
        <div>
          <span class="badge badge-success" id="selected-assets-count">0ê°œ ì„ íƒ</span>
          <button class="btn btn-outline btn-sm" onclick="clearSelectedAssets()" style="margin-left: 1rem;">ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
      </div>
      <div class="table-container">
        <table class="table">
          <thead>
          <tr>
            <th>ìˆœì„œ</th>
            <th>í‹°ì»¤</th>
            <th>ì¢…ëª©ëª…</th>
            <th>ì—…ì¢…</th>
            <th>PER</th>
            <th>PBR</th>
            <th>ROE</th>
            <th>ì•¡ì…˜</th>
          </tr>
          </thead>
          <tbody id="selected-assets-body">
          <tr>
            <td colspan="8" style="text-align: center; color: var(--text-gray); padding: 2rem;">
              ì„ íƒëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¢…ëª©ì„ ê²€ìƒ‰í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”.
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Correlation Section -->
  <section id="correlation" class="section">
    <div class="card">
      <div class="card-header">
        <div class="card-title">ìƒê´€ê´€ê³„ ë¶„ì„</div>
        <button class="btn btn-primary btn-sm" onclick="performCorrelationAnalysis()">ğŸ“Š ë¶„ì„ ì‹¤í–‰</button>
      </div>

      <div class="alert alert-info">
        <span>â„¹ï¸</span>
        <div>
          ì„ íƒí•œ ì¢…ëª©ë“¤ ê°„ì˜ ìƒê´€ê´€ê³„ë¥¼ ë¶„ì„í•˜ì—¬ í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì‚° íš¨ê³¼ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.
          (3ê°œì›”, 6ê°œì›”, 1ë…„ ê¸°ê°„ë³„ ë¶„ì„)
        </div>
      </div>

      <div id="correlation-result"></div>
    </div>

    <!-- Correlation Matrix -->
    <div class="card" id="correlation-matrix-card" style="display: none;">
      <div class="card-header">
        <div class="card-title">ìƒê´€ê´€ê³„ í–‰ë ¬</div>
        <div class="form-group" style="margin: 0; width: 200px;">
          <select id="correlation-period" class="form-control" onchange="updateCorrelationMatrix()">
            <option value="1Y">1ë…„</option>
            <option value="6M">6ê°œì›”</option>
            <option value="3M">3ê°œì›”</option>
          </select>
        </div>
      </div>
      <div id="correlation-matrix"></div>
    </div>

    <!-- Diversification Guide -->
    <div class="card" id="diversification-card" style="display: none;">
      <div class="card-header">
        <div class="card-title">ë¶„ì‚°íˆ¬ì ê°€ì´ë“œ</div>
      </div>
      <div id="diversification-guide"></div>
    </div>
  </section>
</div>

<script>
  // ========================================
  // Global Variables
  // ========================================
  let API_BASE_URL = 'http://localhost:8282';
  let currentScreeningResults = [];
  let currentCorrelationData = null;
  let selectedAssets = [];

  // ========================================
  // Navigation
  // ========================================
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', function() {
      const sectionId = this.getAttribute('data-section');

      // Update nav links
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      this.classList.add('active');

      // Update sections
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');

      // Load section data
      if (sectionId === 'selection') {
        loadSelectedAssets();
      }
    });
  });

  // ========================================
  // API Functions
  // ========================================
  async function apiCall(endpoint, options = {}) {
    const url = API_BASE_URL + endpoint;

    try {
      const response = await fetch(url, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        credentials: 'include' // ì„¸ì…˜ ì¿ í‚¤ í¬í•¨
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      return await response.json();
    } catch (error) {
      console.error('API Call Error:', error);
      throw error;
    }
  }

  // ========================================
  // Connection Test
  // ========================================
  async function testConnection() {
    const urlInput = document.getElementById('api-base-url');
    API_BASE_URL = urlInput.value.trim();

    const resultDiv = document.getElementById('connection-result');
    resultDiv.innerHTML = '<div class="spinner"></div>';

    try {
      // Test endpoint: ì£¼ì‹ ëª©ë¡ ì¡°íšŒ (ì²« í˜ì´ì§€ë§Œ)
      const response = await apiCall('/api/stocks?page=1&pageSize=10');

      resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <span>âœ…</span>
                        <div>
                            <strong>ì—°ê²° ì„±ê³µ!</strong><br>
                            ì´ ${response.totalElements || 0}ê°œì˜ ì¢…ëª© ë°ì´í„° í™•ì¸ë¨
                        </div>
                    </div>
                `;

      // Update dashboard stats
      document.getElementById('total-stocks').textContent = response.totalElements || 0;
      document.getElementById('api-url').textContent = API_BASE_URL;

    } catch (error) {
      resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <span>âŒ</span>
                        <div>
                            <strong>ì—°ê²° ì‹¤íŒ¨</strong><br>
                            ${error.message}
                        </div>
                    </div>
                `;
    }
  }

  // ========================================
  // Weight Management
  // ========================================
  function updateWeights() {
    const per = parseFloat(document.getElementById('per-weight').value) || 0;
    const pbr = parseFloat(document.getElementById('pbr-weight').value) || 0;
    const roe = parseFloat(document.getElementById('roe-weight').value) || 0;

    const sum = per + pbr + roe;
    const sumElement = document.getElementById('weight-sum');
    sumElement.textContent = sum.toFixed(2) + '%';

    // Color coding
    if (Math.abs(sum - 100) < 0.01) {
      sumElement.style.color = 'var(--success)';
    } else {
      sumElement.style.color = 'var(--error)';
    }
  }

  function resetWeights() {
    document.getElementById('per-weight').value = 33.33;
    document.getElementById('pbr-weight').value = 33.33;
    document.getElementById('roe-weight').value = 33.34;
    updateWeights();
  }

  // ========================================
  // Screening
  // ========================================
  async function performScreening() {
    const per = parseFloat(document.getElementById('per-weight').value) / 100;
    const pbr = parseFloat(document.getElementById('pbr-weight').value) / 100;
    const roe = parseFloat(document.getElementById('roe-weight').value) / 100;
    const maxDebtRatio = parseFloat(document.getElementById('max-debt-ratio').value);

    // Validate weights
    const sum = per + pbr + roe;
    if (Math.abs(sum - 1.0) > 0.001) {
      showAlert('screening-result', 'error', 'ê°€ì¤‘ì¹˜ì˜ í•©ì´ 100%ê°€ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.');
      return;
    }

    const resultDiv = document.getElementById('screening-result');
    resultDiv.innerHTML = '<div class="spinner"></div>';

    try {
      const response = await apiCall('/api/screening/perform', {
        method: 'POST',
        body: JSON.stringify({
          perWeight: per.toFixed(4),
          pbrWeight: pbr.toFixed(4),
          roeWeight: roe.toFixed(4),
          maxDebtRatio: maxDebtRatio
        })
      });

      currentScreeningResults = response.screeningResults || [];

      resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <span>âœ…</span>
                        <div>
                            <strong>ìŠ¤í¬ë¦¬ë‹ ì™„ë£Œ!</strong><br>
                            ì´ ${response.totalStocksAnalyzed}ê°œ ë¶„ì„, ìƒìœ„ ${response.selectedStocksCount}ê°œ ì„ ë³„
                        </div>
                    </div>
                `;

      // Show results table
      displayScreeningResults(currentScreeningResults);
      document.getElementById('screening-count').textContent = response.selectedStocksCount;

    } catch (error) {
      resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <span>âŒ</span>
                        <div>
                            <strong>ìŠ¤í¬ë¦¬ë‹ ì‹¤íŒ¨</strong><br>
                            ${error.message}
                        </div>
                    </div>
                `;
    }
  }

  function displayScreeningResults(results) {
    const card = document.getElementById('screening-results-card');
    const tbody = document.getElementById('screening-results-body');
    const countBadge = document.getElementById('result-count');

    card.style.display = 'block';
    countBadge.textContent = `${results.length}ê°œ ì¢…ëª©`;

    tbody.innerHTML = results.map(stock => `
                <tr>
                    <td><strong>${stock.ranking}</strong></td>
                    <td><span class="stock-symbol">${stock.ticker}</span></td>
                    <td>${stock.stockName}</td>
                    <td>${stock.industry || '-'}</td>
                    <td>${stock.per ? stock.per.toFixed(2) : '-'}</td>
                    <td>${stock.pbr ? stock.pbr.toFixed(2) : '-'}</td>
                    <td>${stock.roe ? stock.roe.toFixed(2) : '-'}%</td>
                    <td><strong>${stock.compositeScore ? stock.compositeScore.toFixed(4) : '-'}</strong></td>
                    <td>
                        ${stock.isSelected ?
            '<span class="badge badge-success">ì„ ë³„ë¨</span>' :
            '<span class="badge">-</span>'}
                    </td>
                </tr>
            `).join('');
  }

  // ========================================
  // Stock Search
  // ========================================
  async function searchStocks() {
    const searchType = document.getElementById('search-type').value;
    const searchValue = document.getElementById('search-value').value.trim();

    if (!searchValue) {
      showAlert('search-results', 'warning', 'ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const resultDiv = document.getElementById('search-results');
    resultDiv.innerHTML = '<div class="spinner"></div>';

    try {
      const response = await apiCall(
              `/api/stocks/search?searchType=${searchType}&searchValue=${encodeURIComponent(searchValue)}&page=1&pageSize=30`
      );

      const stocks = response.content || [];

      if (stocks.length === 0) {
        resultDiv.innerHTML = `
                        <div class="alert alert-info" style="margin-top: 1rem;">
                            <span>â„¹ï¸</span>
                            <div>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                    `;
        return;
      }

      resultDiv.innerHTML = `
                    <div class="card" style="margin-top: 1rem;">
                        <div class="card-header">
                            <div class="card-title">ê²€ìƒ‰ ê²°ê³¼</div>
                            <span class="badge badge-primary">${stocks.length}ê°œ ì¢…ëª©</span>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ì„ íƒ</th>
                                        <th>í‹°ì»¤</th>
                                        <th>ì¢…ëª©ëª…</th>
                                        <th>ì—…ì¢…</th>
                                        <th>PER</th>
                                        <th>PBR</th>
                                        <th>ROE</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${stocks.map(stock => `
                                        <tr>
                                            <td>
                                                <button class="btn btn-outline btn-sm"
                                                    onclick="selectAsset('${stock.ticker}')"
                                                    ${selectedAssets.some(a => a.ticker === stock.ticker) ? 'disabled' : ''}>
                                                    ${selectedAssets.some(a => a.ticker === stock.ticker) ? 'âœ“ ì„ íƒë¨' : 'ì„ íƒ'}
                                                </button>
                                            </td>
                                            <td><span class="stock-symbol">${stock.ticker}</span></td>
                                            <td>${stock.stockName}</td>
                                            <td>${stock.industry || '-'}</td>
                                            <td>${stock.per ? stock.per.toFixed(2) : '-'}</td>
                                            <td>${stock.pbr ? stock.pbr.toFixed(2) : '-'}</td>
                                            <td>${stock.roe ? stock.roe.toFixed(2) : '-'}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

    } catch (error) {
      resultDiv.innerHTML = `
                    <div class="alert alert-error" style="margin-top: 1rem;">
                        <span>âŒ</span>
                        <div>ê²€ìƒ‰ ì‹¤íŒ¨: ${error.message}</div>
                    </div>
                `;
    }
  }

  // ========================================
  // Asset Selection
  // ========================================
  async function selectAsset(ticker) {
    if (selectedAssets.length >= 10) {
      alert('ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      return;
    }

    try {
      const response = await apiCall('/api/stocks/select', {
        method: 'POST',
        body: JSON.stringify({ ticker: ticker })
      });

      if (response.success) {
        await loadSelectedAssets();
        searchStocks(); // Refresh search results
      }

    } catch (error) {
      alert('ìì‚° ì„ íƒ ì‹¤íŒ¨: ' + error.message);
    }
  }

  async function loadSelectedAssets() {
    try {
      const response = await apiCall('/api/stocks/selected');
      selectedAssets = response.data || [];

      const tbody = document.getElementById('selected-assets-body');
      const countBadge = document.getElementById('selected-assets-count');

      countBadge.textContent = `${selectedAssets.length}ê°œ ì„ íƒ`;
      document.getElementById('selected-count').textContent = selectedAssets.length;

      if (selectedAssets.length === 0) {
        tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; color: var(--text-gray); padding: 2rem;">
                                ì„ íƒëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì—ì„œ ì¢…ëª©ì„ ê²€ìƒ‰í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”.
                            </td>
                        </tr>
                    `;
      } else {
        tbody.innerHTML = selectedAssets.map((asset, index) => `
                        <tr>
                            <td><strong>${index + 1}</strong></td>
                            <td><span class="stock-symbol">${asset.ticker}</span></td>
                            <td>${asset.stockName}</td>
                            <td>${asset.industry || '-'}</td>
                            <td>${asset.per ? asset.per.toFixed(2) : '-'}</td>
                            <td>${asset.pbr ? asset.pbr.toFixed(2) : '-'}</td>
                            <td>${asset.roe ? asset.roe.toFixed(2) : '-'}%</td>
                            <td>
                                <button class="btn btn-outline btn-sm" onclick="deselectAsset('${asset.ticker}')">
                                    ì‚­ì œ
                                </button>
                            </td>
                        </tr>
                    `).join('');
      }

    } catch (error) {
      console.error('Failed to load selected assets:', error);
    }
  }

  async function deselectAsset(ticker) {
    try {
      await apiCall(`/api/stocks/deselect/${ticker}`, {
        method: 'DELETE'
      });
      await loadSelectedAssets();

    } catch (error) {
      alert('ìì‚° ì„ íƒ í•´ì œ ì‹¤íŒ¨: ' + error.message);
    }
  }

  async function clearSelectedAssets() {
    if (!confirm('ì„ íƒí•œ ëª¨ë“  ì¢…ëª©ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }

    try {
      await apiCall('/api/stocks/clear', {
        method: 'DELETE'
      });
      await loadSelectedAssets();

    } catch (error) {
      alert('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
    }
  }

  // ========================================
  // Correlation Analysis
  // ========================================
  async function performCorrelationAnalysis() {
    const resultDiv = document.getElementById('correlation-result');

    if (selectedAssets.length < 2) {
      resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <span>âš ï¸</span>
                        <div>ìƒê´€ê´€ê³„ ë¶„ì„ì„ ìœ„í•´ì„œëŠ” ìµœì†Œ 2ê°œì˜ ì¢…ëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
                    </div>
                `;
      return;
    }

    resultDiv.innerHTML = '<div class="spinner"></div>';

    try {
      const tickers = selectedAssets.map(a => a.ticker);

      const response = await apiCall('/api/correlation/analyze', {
        method: 'POST',
        body: JSON.stringify({
          tickers: tickers,
          period: 'ALL',
          highCorrelationThreshold: 0.7
        })
      });

      currentCorrelationData = response.data;

      resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <span>âœ…</span>
                        <div>
                            <strong>ë¶„ì„ ì™„ë£Œ!</strong><br>
                            ${response.data.correlations.length}ê°œì˜ ìƒê´€ê´€ê³„ ìŒ ë¶„ì„ë¨
                        </div>
                    </div>
                `;

      // Display correlation matrix
      displayCorrelationMatrix(response.data);
      displayDiversificationGuide(response.data.diversificationGuide);

    } catch (error) {
      resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <span>âŒ</span>
                        <div>ë¶„ì„ ì‹¤íŒ¨: ${error.message}</div>
                    </div>
                `;
    }
  }

  function displayCorrelationMatrix(data) {
    const card = document.getElementById('correlation-matrix-card');
    const matrixDiv = document.getElementById('correlation-matrix');

    card.style.display = 'block';

    const period = document.getElementById('correlation-period').value;
    const matrix = data.correlationMatrix[period];

    if (!matrix || !matrix.tickers) {
      matrixDiv.innerHTML = '<p>ìƒê´€ê´€ê³„ ë§¤íŠ¸ë¦­ìŠ¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    const tickers = matrix.tickers;
    const values = matrix.values;

    let html = `
                <div style="overflow-x: auto;">
                    <table class="table" style="min-width: 600px;">
                        <thead>
                            <tr>
                                <th></th>
                                ${tickers.map(t => `<th>${t}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;

    tickers.forEach((ticker1, i) => {
      html += `<tr><td><strong>${ticker1}</strong></td>`;
      tickers.forEach((ticker2, j) => {
        const value = values[i][j];
        const color = getCorrelationColor(value);
        html += `<td style="background-color: ${color}; text-align: center;">
                        ${value !== null ? value.toFixed(3) : '-'}
                    </td>`;
      });
      html += '</tr>';
    });

    html += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background-color: var(--bg-beige); border-radius: 8px;">
                    <div style="font-size: 0.9rem; color: var(--text-gray);">
                        <strong>ë²”ë¡€:</strong>
                        <span style="display: inline-block; width: 20px; height: 20px; background: #E74C3C; margin-left: 1rem;"></span> ë†’ì€ ìƒê´€ê´€ê³„ (0.7~1.0)
                        <span style="display: inline-block; width: 20px; height: 20px; background: #F39C12; margin-left: 0.5rem;"></span> ì¤‘ê°„ ìƒê´€ê´€ê³„ (0.3~0.7)
                        <span style="display: inline-block; width: 20px; height: 20px; background: #27AE60; margin-left: 0.5rem;"></span> ë‚®ì€ ìƒê´€ê´€ê³„ (0~0.3)
                    </div>
                </div>
            `;

    matrixDiv.innerHTML = html;
  }

  function displayDiversificationGuide(guide) {
    const card = document.getElementById('diversification-card');
    const guideDiv = document.getElementById('diversification-guide');

    card.style.display = 'block';

    const riskColors = {
      'EXCELLENT': 'var(--success)',
      'GOOD': 'var(--accent-blue)',
      'FAIR': 'var(--highlight-orange)',
      'POOR': 'var(--error)'
    };

    let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ë¶„ì‚°ì ìˆ˜</div>
                        <div class="stat-value">${guide.overallDiversificationScore.toFixed(1)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ìœ„í—˜ë„ í‰ê°€</div>
                        <div class="stat-value" style="color: ${riskColors[guide.riskAssessment]};">
                            ${guide.riskAssessment}
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ë†’ì€ ìƒê´€ê´€ê³„ ìŒ</div>
                        <div class="stat-value">${guide.highlyCorrelatedPairCount}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">í‰ê·  ìƒê´€ê³„ìˆ˜</div>
                        <div class="stat-value">${guide.averageCorrelation.toFixed(3)}</div>
                    </div>
                </div>

                <div style="margin-top: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">ğŸ’¡ ì¶”ì²œì‚¬í•­</h3>
                    ${guide.recommendations.map(rec => `
                        <div class="alert alert-info" style="margin-bottom: 0.5rem;">
                            <span>â€¢</span>
                            <div>${rec}</div>
                        </div>
                    `).join('')}
                </div>

                ${guide.warnings && guide.warnings.length > 0 ? `
                    <div style="margin-top: 1.5rem;">
                        <h3 style="margin-bottom: 1rem;">âš ï¸ ê²½ê³ ì‚¬í•­</h3>
                        ${guide.warnings.map(warn => `
                            <div class="alert alert-warning" style="margin-bottom: 0.5rem;">
                                <span>â€¢</span>
                                <div>${warn}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;

    guideDiv.innerHTML = html;
  }

  function updateCorrelationMatrix() {
    if (currentCorrelationData) {
      displayCorrelationMatrix(currentCorrelationData);
    }
  }

  function getCorrelationColor(value) {
    if (value === null) return '#f0f0f0';
    const abs = Math.abs(value);
    if (abs >= 0.7) return '#E74C3C';
    if (abs >= 0.3) return '#F39C12';
    return '#27AE60';
  }

  // ========================================
  // Utility Functions
  // ========================================
  function showAlert(elementId, type, message) {
    const element = document.getElementById(elementId);
    const icons = {
      success: 'âœ…',
      error: 'âŒ',
      warning: 'âš ï¸',
      info: 'â„¹ï¸'
    };

    element.innerHTML = `
                <div class="alert alert-${type}">
                    <span>${icons[type] || 'â„¹ï¸'}</span>
                    <div>${message}</div>
                </div>
            `;
  }

  // ========================================
  // Initialize
  // ========================================
  window.addEventListener('DOMContentLoaded', () => {
    console.log('Portfolio Optimizer - Frontend Loaded');
    updateWeights();
  });
</script>
</body>
</html>