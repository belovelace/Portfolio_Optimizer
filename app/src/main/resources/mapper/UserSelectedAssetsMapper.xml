<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.app.domain.stock.mapper.UserSelectedAssetsMapper">

    <!-- ===== 결과 매핑 정의 ===== -->
    <resultMap id="userSelectedAssetsResultMap" type="com.app.domain.stock.entity.UserSelectedAssets">
        <!-- 기본 필드 매핑 -->
        <id property="selectionId" column="selection_id"/>
        <result property="sessionId" column="session_id"/>
        <result property="ticker" column="ticker"/>
        <result property="selectionOrder" column="selection_order"/>
        <result property="selectedAt" column="selected_at"/>

        <!-- 조인된 Stock 테이블 정보 매핑 -->
        <result property="stockName" column="stock_name"/>
        <result property="industry" column="industry"/>
        <result property="closePrice" column="close_price"/>
        <result property="per" column="per"/>
        <result property="pbr" column="pbr"/>
        <result property="roe" column="roe"/>
    </resultMap>

    <!-- ===== 등록(Create) SQL ===== -->
    <insert id="insertSelectedAsset" parameterType="com.app.domain.stock.entity.UserSelectedAssets">
        INSERT INTO user_selected_assets (
            session_id,
            ticker,
            selection_order,
            selected_at
        ) VALUES (
                     #{sessionId},
                     #{ticker},
                     #{selectionOrder},
                     NOW()
                 )
    </insert>

    <!-- ===== 조회(Read) SQL ===== -->
    <!-- 세션별 선택된 자산 목록 조회 (주식 정보 포함) -->
    <select id="selectAssetsBySession" parameterType="string" resultMap="userSelectedAssetsResultMap">
        SELECT
            usa.selection_id,
            usa.session_id,
            usa.ticker,
            usa.selection_order,
            usa.selected_at,
            s.stock_name,
            s.industry,
            s.close_price,
            s.per,
            s.pbr,
            s.roe
        FROM user_selected_assets usa
                 INNER JOIN stock s ON usa.ticker = s.ticker
        WHERE usa.session_id = #{sessionId}
        ORDER BY usa.selection_order ASC, usa.selected_at ASC
    </select>

    <!-- 세션별 선택된 자산 개수 조회 -->
    <select id="countSelectedAssets" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM user_selected_assets
        WHERE session_id = #{sessionId}
    </select>

    <!-- 특정 자산 선택 여부 확인 -->
    <select id="isAssetSelected" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM user_selected_assets
        WHERE session_id = #{sessionId} AND ticker = #{ticker}
    </select>

    <!-- 세션별 다음 선택 순서 조회 -->
    <select id="getNextSelectionOrder" parameterType="string" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(selection_order), 0) + 1
        FROM user_selected_assets
        WHERE session_id = #{sessionId}
    </select>

    <!-- ===== 수정(Update) SQL ===== -->
    <!-- 선택 순서 업데이트 -->
    <update id="updateSelectionOrder">
        UPDATE user_selected_assets
        SET selection_order = #{selectionOrder}
        WHERE session_id = #{sessionId} AND ticker = #{ticker}
    </update>

    <!-- ===== 삭제(Delete) SQL ===== -->
    <!-- 특정 자산 선택 삭제 -->
    <delete id="deleteSelectedAsset">
        DELETE FROM user_selected_assets
        WHERE session_id = #{sessionId} AND ticker = #{ticker}
    </delete>

    <!-- 세션별 모든 선택 삭제 -->
    <delete id="deleteAllSelectedAssets" parameterType="string">
        DELETE FROM user_selected_assets
        WHERE session_id = #{sessionId}
    </delete>

</mapper>