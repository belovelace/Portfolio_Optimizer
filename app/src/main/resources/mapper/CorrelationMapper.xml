<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.app.domain.correlation.mapper.CorrelationMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="correlationAnalysisResultMap" type="com.app.domain.correlation.entity.CorrelationAnalysis">
        <id property="correlationId" column="correlation_id"/>
        <result property="sessionId" column="session_id"/>
        <result property="ticker1" column="ticker1"/>
        <result property="ticker2" column="ticker2"/>
        <result property="correlation3m" column="correlation_3m"/>
        <result property="correlation6m" column="correlation_6m"/>
        <result property="correlation1y" column="correlation_1y"/>
        <result property="analysisStartDate" column="analysis_start_date"/>
        <result property="analysisEndDate" column="analysis_end_date"/>
        <result property="analysisDate" column="analysis_date"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>



    <!-- ============================================ -->
    <!-- 기존 쿼리 (호환성 유지) -->
    <!-- ============================================ -->

    <insert id="insertCorrelationAnalysis" parameterType="com.app.domain.correlation.entity.CorrelationAnalysis"
            useGeneratedKeys="true" keyProperty="correlationId">
        INSERT INTO correlation_analysis
        (session_id, ticker1, ticker2, correlation_3m, correlation_6m, correlation_1y, analysis_date)
        VALUES
            (#{sessionId}, #{ticker1}, #{ticker2}, #{correlation3m}, #{correlation6m}, #{correlation1y}, #{analysisDate})
    </insert>

    <select id="findBySessionId" parameterType="string" resultMap="correlationAnalysisResultMap">
        SELECT * FROM correlation_analysis WHERE session_id = #{sessionId}
    </select>

    <select id="findHighCorrelations" resultMap="correlationAnalysisResultMap">
        SELECT * FROM correlation_analysis
        WHERE session_id = #{sessionId} AND ABS(correlation_1y) >= #{threshold}
    </select>

    <select id="findSelectedTickers" parameterType="string" resultType="string">
        SELECT ticker FROM user_selected_assets WHERE session_id = #{sessionId}
    </select>

    <delete id="deleteAnalysisResults" parameterType="string">
        DELETE FROM correlation_analysis WHERE session_id = #{sessionId}
    </delete>



    <!-- ============================================ -->
    <!-- 분산 최적화용 쿼리 (신규) -->
    <!-- ============================================ -->

    <!-- 세션 ID로 상관관계 데이터 조회 -->
    <select id="selectCorrelationsBySessionId" resultMap="correlationAnalysisResultMap">
        SELECT
            correlation_id,
            session_id,
            ticker1,
            ticker2,
            correlation_3m,
            correlation_6m,
            correlation_1y,
            analysis_start_date,
            analysis_end_date,
            analysis_date,
            created_at
        FROM correlation_analysis
        WHERE session_id = #{sessionId}
        ORDER BY analysis_date DESC, ticker1, ticker2
    </select>

    <!-- 특정 티커들 간의 상관관계 조회 -->
    <select id="selectCorrelationsByTickers" resultMap="correlationAnalysisResultMap">
        SELECT
        correlation_id,
        session_id,
        ticker1,
        ticker2,
        correlation_3m,
        correlation_6m,
        correlation_1y,
        analysis_start_date,
        analysis_end_date,
        analysis_date,
        created_at
        FROM correlation_analysis
        WHERE session_id = #{sessionId}
        AND ticker1 IN
        <foreach collection="tickers" item="ticker" open="(" separator="," close=")">
            #{ticker}
        </foreach>
        AND ticker2 IN
        <foreach collection="tickers" item="ticker" open="(" separator="," close=")">
            #{ticker}
        </foreach>
        ORDER BY ticker1, ticker2
    </select>

    <!-- 특정 티커와 다른 티커들 간의 상관관계 조회 -->
    <select id="selectCorrelationsByTicker" resultMap="correlationAnalysisResultMap">
        SELECT
            correlation_id,
            session_id,
            ticker1,
            ticker2,
            correlation_3m,
            correlation_6m,
            correlation_1y,
            analysis_start_date,
            analysis_end_date,
            analysis_date,
            created_at
        FROM correlation_analysis
        WHERE session_id = #{sessionId}
          AND (ticker1 = #{ticker} OR ticker2 = #{ticker})
        ORDER BY analysis_date DESC, ticker1, ticker2
    </select>

    <!-- 상관관계 데이터 삽입 -->
    <insert id="insertCorrelation" parameterType="com.app.domain.correlation.entity.CorrelationAnalysis"
            useGeneratedKeys="true" keyProperty="correlationId">
        INSERT INTO correlation_analysis (
            session_id,
            ticker1,
            ticker2,
            correlation_3m,
            correlation_6m,
            correlation_1y,
            analysis_start_date,
            analysis_end_date,
            analysis_date
        ) VALUES (
                     #{sessionId},
                     #{ticker1},
                     #{ticker2},
                     #{correlation3m},
                     #{correlation6m},
                     #{correlation1y},
                     #{analysisStartDate},
                     #{analysisEndDate},
                     #{analysisDate}
                 )
    </insert>

    <!-- 상관관계 데이터 일괄 삽입 -->
    <insert id="insertCorrelationsBatch">
        INSERT INTO correlation_analysis (
        session_id,
        ticker1,
        ticker2,
        correlation_3m,
        correlation_6m,
        correlation_1y,
        analysis_start_date,
        analysis_end_date,
        analysis_date
        ) VALUES
        <foreach collection="correlations" item="corr" separator=",">
            (
            #{corr.sessionId},
            #{corr.ticker1},
            #{corr.ticker2},
            #{corr.correlation3m},
            #{corr.correlation6m},
            #{corr.correlation1y},
            #{corr.analysisStartDate},
            #{corr.analysisEndDate},
            #{corr.analysisDate}
            )
        </foreach>
    </insert>

    <!-- 피어슨 상관계수 계산: CAST를 사용하여 Double 타입으로 반환 -->
    <select id="calculatePearsonCorrelation" resultType="Double">
        SELECT CAST(
                       CASE
                           WHEN COUNT(*) > 1 AND
                                STDDEV(r1.daily_return) > 0 AND
                                STDDEV(r2.daily_return) > 0
                               THEN
                               (SUM((r1.daily_return - avg_r1.avg_return) * (r2.daily_return - avg_r2.avg_return)) /
                                (COUNT(*) * STDDEV(r1.daily_return) * STDDEV(r2.daily_return)))
                           ELSE NULL
                           END
                   AS DECIMAL(10,6)) AS correlation
        FROM stock_price r1
                 INNER JOIN stock_price r2
                            ON r1.price_date = r2.price_date
                 CROSS JOIN (
            SELECT AVG(daily_return) as avg_return
            FROM stock_price
            WHERE ticker = #{ticker1}
              AND price_date BETWEEN #{startDate} AND #{endDate}
        ) avg_r1
                 CROSS JOIN (
            SELECT AVG(daily_return) as avg_return
            FROM stock_price
            WHERE ticker = #{ticker2}
              AND price_date BETWEEN #{startDate} AND #{endDate}
        ) avg_r2
        WHERE r1.ticker = #{ticker1}
          AND r2.ticker = #{ticker2}
          AND r1.price_date BETWEEN #{startDate} AND #{endDate}
          AND r2.price_date BETWEEN #{startDate} AND #{endDate}
    </select>


<!--    &lt;!&ndash;  티커 목록으로 종목명 조회 (Map 반환) &ndash;&gt;-->
<!--    <select id="findStockNamesByTickers" resultType="map">-->
<!--        SELECT-->
<!--        ticker,-->
<!--        stock_name AS stockName-->
<!--        FROM stock-->
<!--        WHERE ticker IN-->
<!--        <foreach collection="tickers" item="ticker" open="(" separator="," close=")">-->
<!--            #{ticker}-->
<!--        </foreach>-->
<!--    </select>-->

<!--    &lt;!&ndash;  단일 티커로 종목명 조회 &ndash;&gt;-->
<!--    <select id="findStockNameByTicker" resultType="string">-->
<!--        SELECT stock_name-->
<!--        FROM stock-->
<!--        WHERE ticker = #{ticker}-->
<!--    </select>-->

    <!--
        @MapKey("ticker") 어노테이션을 Mapper 인터페이스에 추가해야 함
        또는 selectList를 사용하여 Service에서 Map으로 변환
    -->
<!--    <select id="findStockNamesByTickers" resultType="hashmap">-->
<!--        SELECT-->
<!--        ticker,-->
<!--        stock_name AS stockName-->
<!--        FROM stock-->
<!--        WHERE ticker IN-->
<!--        <foreach collection="tickers" item="ticker" open="(" separator="," close=")">-->
<!--            #{ticker}-->
<!--        </foreach>-->
<!--    </select>-->


    <!-- 티커 목록으로 종목 정보 조회 -->
    <select id="findStockInfosByTickers"
            resultType="com.app.domain.correlation.mapper.CorrelationMapper$StockInfo">
        SELECT
        ticker,
        stock_name AS stockName
        FROM stock
        WHERE ticker IN
        <foreach collection="tickers" item="ticker" open="(" separator="," close=")">
            #{ticker}
        </foreach>
    </select>

    <!-- 단일 티커로 종목명 조회 -->
    <select id="findStockNameByTicker" resultType="string">
        SELECT stock_name
        FROM stock
        WHERE ticker = #{ticker}
    </select>

</mapper>