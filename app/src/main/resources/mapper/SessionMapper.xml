<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.app.domain.session.mapper.SessionMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="UserSessionMap" type="com.app.domain.session.entity.UserSession">
        <id property="sessionId" column="session_id"/>
        <result property="userIp" column="user_ip"/>
        <result property="userAgent" column="user_agent"/>
        <result property="createdAt" column="created_at"/>
        <result property="lastAccessed" column="last_accessed"/>
        <result property="isActive" column="is_active"/>
    </resultMap>

<!--    &lt;!&ndash; HTTP 세션 ID로 비즈니스 세션 ID 조회 &ndash;&gt;-->
<!--    <select id="findBusinessSessionIdByHttpSessionId" resultType="string">-->
<!--        SELECT session_id-->
<!--        FROM user_session-->
<!--        WHERE http_session_id = #{httpSessionId}-->
<!--          AND is_active = TRUE-->
<!--            LIMIT 1-->
<!--    </select>-->

<!--    &lt;!&ndash; 비즈니스 세션 ID로 HTTP 세션 ID 조회 &ndash;&gt;-->
<!--    <select id="findHttpSessionIdByBusinessSessionId" resultType="string">-->
<!--        SELECT http_session_id-->
<!--        FROM user_session-->
<!--        WHERE session_id = #{businessSessionId}-->
<!--          AND is_active = TRUE-->
<!--            LIMIT 1-->
<!--    </select>-->

    <!-- 세션 삽입 -->
    <insert id="insertSession" parameterType="com.app.domain.session.entity.UserSession">
        INSERT INTO user_session (
            session_id, user_ip, user_agent,
            created_at, last_accessed, is_active
        ) VALUES (
                     #{sessionId}, #{userIp}, #{userAgent},
                     NOW(), NOW(), #{isActive}
                 )
    </insert>

    <!-- 세션 조회 -->
    <select id="findBySessionId" parameterType="string" resultMap="UserSessionMap">
        SELECT session_id, user_ip, user_agent,
               created_at, last_accessed, is_active
        FROM user_session
        WHERE session_id = #{sessionId} AND is_active = 1
    </select>

    <!-- 마지막 접근 시간 업데이트 -->
    <update id="updateLastAccessed" parameterType="string">
        UPDATE user_session
        SET last_accessed = NOW()
        WHERE session_id = #{sessionId}
    </update>

    <!-- 세션 무효화 -->
    <update id="invalidateSession" parameterType="string">
        UPDATE user_session
        SET is_active = 0
        WHERE session_id = #{sessionId}
    </update>

    <!-- 모든 활성 세션 조회 -->
    <select id="findAllActiveSessions" resultMap="UserSessionMap">
        SELECT session_id, user_ip, user_agent,
               created_at, last_accessed, is_active
        FROM user_session
        WHERE is_active = 1
        ORDER BY created_at DESC
    </select>

    <!-- 만료된 세션 정리 -->
    <delete id="cleanupExpiredSessions">
        DELETE FROM user_session
        WHERE last_accessed <![CDATA[<]]> DATE_SUB(NOW(), INTERVAL 24 HOUR)
    </delete>

    <!-- 세션 존재 여부 확인 -->
    <select id="existsBySessionId" parameterType="string" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM user_session
        WHERE session_id = #{sessionId} AND is_active = 1
    </select>

</mapper>